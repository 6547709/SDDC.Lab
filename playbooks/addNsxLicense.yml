---
- hosts: localhost
  gather_facts: false
  vars:
    nsxlicensekey: "{{ lookup('file', '{{ nsxlicense }}') }}"
  vars_files:
    - ../answerfile.yml
  tasks:

    - name: Check if NSX-T manager is responding with status 200
      uri:
        url: https://{{ item.value.ip }}
        validate_certs: False
        timeout: 5
        method: GET
        status_code: 200
      with_dict: "{{ nsxman }}"
      register: result
      until: result.status == 200
      retries: 60
      delay: 30
      when: 
        - deploy_nsxt == true

    - name: Check if the NSX-T management cluster is reporting "STABLE"
      uri:
        url: https://{{ item.value.ip }}/api/v1/cluster/status
        validate_certs: no
        timeout: 5
        force_basic_auth: yes
        url_username: "{{ nsxmanadminuser }}"
        url_password: "{{ nsxmanpassword }}"
        method: GET
        body_format: json
        return_content: yes
        status_code: 200
      with_dict: "{{ nsxman }}"
      register: nsxman_check
      until: nsxman_check.json.mgmt_cluster_status.status == "STABLE"
      retries: 60
      delay: 30
      when: 
        - deploy_nsxt == true

    - name: Add NSX-T license
      nsxt_licenses:
        hostname: "{{ nsxman.nsxman01.ip }}"
        username: "{{ nsxmanadminuser }}"
        password: "{{ nsxmanpassword }}"
        validate_certs: False
        license_key: "{{ nsxlicensekey }}"
        state: "present"
      when: 
        - deploy_nsxt == true
