#cloud-config
autoinstall:
  version: 1
  locale: {{ Nested_DNSServer.OS.Locale }}
  keyboard:
    layout: {{ Nested_DNSServer.OS.Keyboard.Layout }}
    variant: {{ Nested_DNSServer.OS.Keyboard.Variant }}
  network:
    network:
      version: 2
      ethernets:
        ens192:
          addresses:
{% if Deploy.Setting.IPv4 %}
            - {{ Nested_DNSServer.OS.Network.IPv4.Address }}/{{ Nested_DNSServer.OS.Network.IPv4.Prefix }}
{% endif %}{# Deploy.Setting.IPv4 #}
{% if Deploy.Setting.IPv6 %}
            - "{{ Nested_DNSServer.OS.Network.IPv6.Address }}/{{ Nested_DNSServer.OS.Network.IPv6.Prefix }}"
{% endif %}{# Deploy.Setting.IPv6 #}
{% if Deploy.Setting.IPv4 %}
          gateway4: {{ Nested_DNSServer.OS.Network.IPv4.Gateway }}
{% endif %}{# Deploy.Setting.IPv4 #}
          nameservers:
            addresses:
{% if Deploy.Setting.IPv4 %}
              - {{ Nested_DNSServer.OS.Network.IPv4.DNS }}
{% endif %}{# Deploy.Setting.IPv4 #}
{% if Deploy.Setting.IPv6 %}
              - "{{ Nested_DNSServer.OS.Network.IPv6.DNS }}"
{% endif %}{# Deploy.Setting.IPv6 #}
            search: 
              - {{ Common.DNS.Domain }}
  identity:
    hostname: {{ Nested_DNSServer.FQDN }}
    username: {{ Nested_DNSServer.OS.Credential.User }}
    password: "$6$ryx4qBcSL3V1qKaU$UVKN5KO0gwjUqha0OQkGX8CL/Dbp3NCPo52vEvXO1/2s3NkFcvw540HPWc1g6/7UFEmYEbeRXFdttuguFsvj00" # VMware1!
  ssh:
    install-server: yes
  packages:
{% for Package in var_UbuntuConfiguration.Configuration.Packages %}
    - {{ Package.Name }}
{% endfor %}{# Package #}
  late-commands:
    - echo '{{ Nested_DNSServer.OS.Credential.User }} ALL=(ALL) NOPASSWD:ALL' > /target/etc/sudoers.d/ubuntu # Allow user to run sudo without password. Required for successfull post configuration.